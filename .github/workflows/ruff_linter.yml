name: Code Analysis with Ruff

on:
  workflow_dispatch:
    inputs:
      fix:
        description: 'Apply fixes automatically'
        type: boolean
        default: false
  push:
    branches:
      - main
      - 'gh/**'
  pull_request:
    branches:
      - main
      - 'gh/**'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    strategy:
      matrix:
        python-version: ["3.9"]
    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        repository: ${{ github.event.pull_request.head.repo.full_name }}
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff==0.6.8
        
    - name: Check or fix code with Ruff
      if: ${{ !inputs.fix }}
      run: |
        ruff check .
        # --isolated is used to skip the allowlist at all so this applies to all files
        # please be careful when using this large changes means everyone needs to rebase
        ruff check --isolated --select F821,F823,W191
        ruff check --select F,I
        ruff format --check

    - name: Apply Ruff fixes
      if: ${{ inputs.fix }}
      run: |
        # Fix general issues
        ruff check --fix .
        # Fix formatting
        ruff format .
        
    - name: Create Pull Request with fixes
      if: ${{ inputs.fix }}
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'Auto-fix: Apply Ruff formatting and fixes'
        title: 'Auto-fix: Apply Ruff formatting and fixes'
        body: |
          This PR applies automatic fixes using Ruff linter and formatter.
          
          Changes were made automatically by the Ruff workflow.
        branch: ruff-fixes-${{ github.event.pull_request.number }}
        base: ${{ github.event.pull_request.head.ref }}
